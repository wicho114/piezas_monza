<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Refacciones Monza</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * { box-sizing: border-box; font-family: Arial, sans-serif; }
    body { margin: 0; background: #f4f6f8; }

    header {
      position: sticky; top: 0; z-index: 1000;
      background: white; padding: 15px;
      display: flex; flex-wrap: wrap; gap: 10px;
      align-items: center; justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,.1);
    }

    .logo {
      font-size: 24px; font-weight: bold;
    }
    .logo span.blue { color: #1e40af; }
    .logo span.red { color: #dc2626; }

    .search-bar {
      flex: 1; display: flex; gap: 10px;
    }
    .search-bar input {
      flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ccc;
    }

    button {
      padding: 10px 14px; border: none; border-radius: 8px;
      cursor: pointer; font-weight: bold;
    }
    .btn-add { background: #16a34a; color: white; }
    .btn-delete { background: #dc2626; color: white; }

    main { padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }

    .card {
      background: white; border-radius: 14px; padding: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,.08);
      display: flex; flex-direction: column; gap: 10px;
    }
    .card img { width: 100%; height: 160px; object-fit: cover; border-radius: 10px; }

    /* MODAL */
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,.5);
      display: none; align-items: center; justify-content: center;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 14px;
      width: 90%; max-width: 420px; display: flex; flex-direction: column; gap: 10px;
    }
    .modal-content input { padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
  </style>
</head>
<body>

<header>
  <div class="logo"><span class="blue">Refacciones</span> <span class="red">Monza</span></div>
  <div class="search-bar">
    <input id="search" placeholder="Buscar pieza..." />
    <button onclick="buscar()">üîç</button>
  </div>
  <button class="btn-add" onclick="abrirModal()">‚ûï Agregar</button>
</header>

<main id="lista"></main>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Agregar nueva pieza</h3>
    <input id="nombre" placeholder="Nombre" />
    <input id="categoria" placeholder="Categor√≠a" />
    <input id="precio" type="number" placeholder="Precio" />
    <input id="foto" type="file" />
    <button class="btn-add" onclick="guardar()">Guardar</button>
    <button onclick="cerrarModal()">Cancelar</button>
  </div>
</div>

<script>
const API = 'http://127.0.0.1:8000';

function abrirModal(){ modal.style.display = 'flex'; }
function cerrarModal(){ modal.style.display = 'none'; }

async function cargar(buscar = ''){
  lista.innerHTML = '';
  const res = await fetch(`${API}/ventas?buscar=${encodeURIComponent(buscar)}`);
  const data = await res.json();

  if (!Array.isArray(data) || data.length === 0) {
    lista.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#666">No se encontraron piezas</p>';
    return;
  }

  data.forEach(p => {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      ${p.foto_url ? `<img src="${p.foto_url}">` : '<div style="height:160px;background:#e5e7eb;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#6b7280">Sin imagen</div>'}
      <strong>${p.nombre}</strong>
      <span>${p.categoria}</span>
      <span>$${p.precio}</span>
      <button class="btn-delete" onclick="eliminar(${p.id})">üóëÔ∏è Borrar</button>
    `;
    lista.appendChild(div);
  });
}

  data.forEach(p => {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      ${p.foto_url ? `<img src="${p.foto_url}">` : ''}
      <strong>${p.nombre}</strong>
      <span>${p.categoria}</span>
      <span>$${p.precio}</span>
      <button class="btn-delete" onclick="eliminar(${p.id})">üóëÔ∏è Borrar</button>
    `;
    lista.appendChild(div);
  });
}

async function guardar(){
  const fd = new FormData();
  fd.append('nombre', nombre.value);
  fd.append('categoria', categoria.value);
  fd.append('precio', precio.value);
  if(foto.files[0]) fd.append('foto', foto.files[0]);

  const res = await fetch(`${API}/vender`, { method:'POST', body: fd });

  if(res.ok){
    Swal.fire('Guardado', 'La pieza fue registrada correctamente', 'success');
    cerrarModal();
    cargar();
  } else {
    Swal.fire('Error', 'No se pudo guardar', 'error');
  }
}

async function eliminar(id){
  const r = await Swal.fire({
    title: '¬øEliminar pieza?',
    icon: 'warning', showCancelButton: true,
    confirmButtonText: 'S√≠, eliminar'
  });

  if(r.isConfirmed){
    const res = await fetch(`${API}/ventas/${id}`, { method:'DELETE' });
    if(res.ok){
      Swal.fire('Eliminado', 'La pieza fue eliminada', 'success');
      cargar();
    }
  }
}

function buscar(){
  const q = search.value;
  cargar(q);
}

cargar();
</script>

</body>
</html>
