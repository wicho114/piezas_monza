<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Refacciones Monza</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS -->
  <link rel="stylesheet" href="styles.css">

  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="light">

  <!-- HEADER -->
  <header class="topbar">
    <h1>
      <span class="blue">Refacciones</span>
      <span class="red">Monza</span>
    </h1>

    <div class="actions">
      <input id="search" placeholder="Buscar pieza..." />
      <button onclick="buscar()">üîç</button>
      <button onclick="abrirModal()">‚ûï Agregar</button>
      <button onclick="toggleTheme()">üåô</button>
    </div>
  </header>

  <!-- PANEL LATERAL -->
  <aside class="sidebar">
    <h3>√öltimas ventas</h3>
    <p id="mensaje"></p>
    <div id="lista" class="grid"></div>
  </aside>

  <!-- MODAL -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2>Nueva pieza</h2>

      <input id="nombre" placeholder="Nombre de la pieza" />
      <input id="categoria" placeholder="Categor√≠a" />
      <input id="precio" type="number" placeholder="Precio" />
      <input id="foto" type="file" accept="image/*" />

      <div class="modal-actions">
        <button onclick="guardar()">Guardar</button>
        <button onclick="cerrarModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script>
    const API = "http://127.0.0.1:8000";

    const lista = document.getElementById("lista");
    const mensaje = document.getElementById("mensaje");
    const modal = document.getElementById("modal");
    const search = document.getElementById("search");

    const nombre = document.getElementById("nombre");
    const categoria = document.getElementById("categoria");
    const precio = document.getElementById("precio");
    const foto = document.getElementById("foto");

    document.addEventListener("DOMContentLoaded", () => {
      cargar();
    });

    function toggleTheme() {
      document.body.classList.toggle("dark");
    }

    function abrirModal() {
      modal.style.display = "flex";
    }

    function cerrarModal() {
      modal.style.display = "none";
    }

    async function cargar(buscar = "") {
      lista.innerHTML = "";
      mensaje.innerText = "Cargando...";

      try {
        const res = await fetch(`${API}/ventas?buscar=${buscar}`);
        const data = await res.json();

        if (!data.length) {
          mensaje.innerText = "Sin resultados";
          return;
        }

        mensaje.innerText = `Mostrando ${Math.min(3, data.length)} piezas`;

        data.slice(0, 3).forEach(p => {
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            ${p.foto_url
              ? `<img src="${p.foto_url}">`
              : `<div class="no-img">Sin imagen</div>`
            }
            <strong>${p.nombre}</strong>
            <span>${p.categoria}</span>
            <span>$${p.precio}</span>
            <button class="btn-delete" onclick="eliminar(${p.id})">üóëÔ∏è Borrar</button>
          `;
          lista.appendChild(div);
        });

      } catch (e) {
        mensaje.innerText = "Error al conectar con la API";
      }
    }

    function buscar() {
      cargar(search.value);
    }

    async function guardar() {
      if (!nombre.value) {
        Swal.fire("Falta nombre", "Ingresa el nombre de la pieza", "warning");
        return;
      }

      const fd = new FormData();
      fd.append("nombre", nombre.value);
      fd.append("categoria", categoria.value || "Otro");
      fd.append("precio", precio.value || 0);
      if (foto.files[0]) fd.append("foto", foto.files[0]);

      try {
        const res = await fetch(`${API}/vender`, {
          method: "POST",
          body: fd
        });

        if (!res.ok) throw new Error();

        Swal.fire("Guardado", "Pieza registrada correctamente", "success");

        cerrarModal();
        nombre.value = "";
        categoria.value = "";
        precio.value = "";
        foto.value = "";

        cargar();

      } catch {
        Swal.fire("Error", "No se pudo guardar", "error");
      }
    }

    async function eliminar(id) {
      const r = await Swal.fire({
        title: "¬øEliminar pieza?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "S√≠, eliminar"
      });

      if (r.isConfirmed) {
        await fetch(`${API}/ventas/${id}`, { method: "DELETE" });
        Swal.fire("Eliminado", "Pieza eliminada", "success");
        cargar();
      }
    }
  </script>

</body>
</html>
