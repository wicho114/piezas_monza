<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Refacciones Monza</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS -->
  <link rel="stylesheet" href="styles.css">

  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="light">

  <!-- HEADER -->
  <header class="topbar">
    <h1>
      <span class="blue">Refacciones</span>
      <span class="red">Monza</span>
    </h1>

    <div class="actions">
      <input id="search" placeholder="Buscar pieza..." />
      <button onclick="buscar()">üîç</button>
      <button class="btn-add" onclick="abrirModal()">‚ûï Agregar</button>
      <button onclick="toggleTheme()">üåô</button>
    </div>
  </header>

  <!-- CONTENEDOR PRINCIPAL -->
  <main class="container">

    <!-- RESULTADOS -->
    <section class="sidebar">
      <h3>√öltimas piezas registradas</h3>
      <p id="mensaje"></p>
      <div id="lista" class="grid"></div>
    </section>

  </main>

  <!-- MODAL -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2>Nueva pieza</h2>

      <input id="nombre" placeholder="Nombre de la pieza" />
      <input id="categoria" placeholder="Categor√≠a" />
      <input id="precio" type="number" placeholder="Precio" />
      <input id="foto" type="file" accept="image/*" />

      <div class="modal-actions">
        <button class="btn-add" onclick="guardar()">Guardar</button>
        <button onclick="cerrarModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script>
    const API = "http://127.0.0.1:8000";

    const lista = document.getElementById("lista");
    const mensaje = document.getElementById("mensaje");
    const modal = document.getElementById("modal");
    const search = document.getElementById("search");

    const nombre = document.getElementById("nombre");
    const categoria = document.getElementById("categoria");
    const precio = document.getElementById("precio");
    const foto = document.getElementById("foto");

    document.addEventListener("DOMContentLoaded", () => {
      cargar();
    });

    function toggleTheme() {
      document.body.classList.toggle("dark");
    }

    function abrirModal() {
      modal.style.display = "flex";
    }

    function cerrarModal() {
      modal.style.display = "none";
    }

    async function cargar(buscar = "") {
      lista.innerHTML = "";
      mensaje.innerText = "Cargando piezas...";

      try {
        const res = await fetch(`${API}/ventas?buscar=${buscar}`);
        const data = await res.json();

        if (!data.length) {
          mensaje.innerText = "No se encontraron resultados";
          return;
        }

        const mostrar = data.slice(0, 3);
        mensaje.innerText = `Mostrando ${mostrar.length} pieza(s) recientes`;

        mostrar.forEach(p => {
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            ${
              p.foto_url
              ? `<img src="${p.foto_url}" alt="pieza">`
              : `<div class="no-img">Sin imagen</div>`
            }
            <strong>${p.nombre}</strong>
            <span>${p.categoria}</span>
            <span>$${p.precio}</span>
            <button class="btn-delete" onclick="eliminar(${p.id})">üóëÔ∏è Borrar</button>
          `;
          lista.appendChild(div);
        });

      } catch (e) {
        mensaje.innerText = "‚ùå Error al conectar con la API";
      }
    }

    function buscar() {
      cargar(search.value);
    }

    async function guardar() {
      if (!nombre.value) {
        Swal.fire("Falta nombre", "Ingresa el nombre de la pieza", "warning");
        return;
      }

      const fd = new FormData();
      fd.append("nombre", nombre.value);
      fd.append("categoria", categoria.value || "Otro");
      fd.append("precio", precio.value || 0);
      if (foto.files[0]) fd.append("foto", foto.files[0]);

      try {
        const res = await fetch(`${API}/vender`, {
          method: "POST",
          body: fd
        });

        if (!res.ok) throw new Error();

        Swal.fire("‚úÖ Guardado", "Pieza registrada correctamente", "success");

        cerrarModal();
        nombre.value = "";
        categoria.value = "";
        precio.value = "";
        foto.value = "";

        cargar();

      } catch {
        Swal.fire("‚ùå Error", "No se pudo guardar la pieza", "error");
      }
    }

    async function eliminar(id) {
      const r = await Swal.fire({
        title: "¬øEliminar pieza?",
        text: "Tambi√©n se borrar√° la imagen",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "S√≠, eliminar"
      });

      if (r.isConfirmed) {
        await fetch(`${API}/ventas/${id}`, { method: "DELETE" });
        Swal.fire("üóëÔ∏è Eliminado", "Pieza eliminada", "success");
        cargar();
      }
    }
  </script>

</body>
</html>
